# 006: reproj_error_threshold の最適化 [未着手]

## 1. 目的

`reproj_error_threshold_triangulation`（現在値: **15.0 px**）を最適化し、三角測量時のカメラ除外判定基準を改善する。

## 2. パラメータの動作

### コード上の動作（triangulation.py）

**whileループ条件（L408）**:
```python
while error_min > error_threshold_triangulation and n_cams - nb_cams_off >= min_cameras_for_triangulation:
```
- 再投影誤差が閾値以下になればループ停止（カメラ除外をやめる）
- 閾値を超えていればさらにカメラを除外して再試行

**最終判定（L600-L603）**:
```python
if error_min > error_threshold_triangulation:
    error_min = np.nan
    Q = np.array([np.nan, np.nan, np.nan])
```
- 全パターンを試しても閾値を超えるなら、そのキーポイント・フレームはNaN

### パラメータの意味

- **閾値が低い（例: 10px）**: より厳格。誤差が大きいカメラを積極的に除外 → 精度↑、除外率↑、NaN率↑
- **閾値が高い（例: 20px）**: より緩和。多くのカメラを使用 → カバレッジ↑、精度↓

### 他パラメータとの相互作用

- reproj_error閾値を下げる → カメラ除外が増える → min_camerasに引っかかりやすい → NaN率↑
- reproj_error閾値を上げる → カメラ除外が減る → likelihood閾値が主要なフィルタになる

## 3. 現在のベースライン

### 再投影誤差の分布（undistort=true, k3解放後）

| 区間 | キーポイント数 | キーポイント例 |
|------|-------------|-------------|
| 10-11 px | 6 | LWrist(10.1), Nose(10.5), LEye(10.7), REye(10.7), LEar(10.8), LElbow(10.9) |
| 11-12 px | 17 | Hip(11.2), RShoulder(11.2), LHip(11.4), RWrist(11.2), ... |
| 12+ px | 3 | RKnee(12.2), RAnkle(12.0), Neck(11.9) |
| **全体平均** | **26** | **11.3 px** |

**現在の閾値15.0pxは全体平均の1.33倍**。大半のキーポイントの平均再投影誤差（10-12px）に対して余裕がある。

### 閾値15.0pxでの除外判定

現在の設定では:
- 平均再投影誤差11.3px < 閾値15.0px → **多くのフレームで除外が発生しない**
- ただし個別フレームでは15pxを超えるケースがあり、その場合にカメラ除外が発生
- 平均0.98台/フレームが除外されている

## 4. テスト条件

| 条件 | reproj_error閾値 | 予想効果 |
|------|-----------------|---------|
| A | **10** px（厳格化） | 除外↑↑、精度↑、NaN↑ |
| B | **12** px（やや厳格化） | 除外↑、精度↑、NaN微増 |
| C | **15** px（現状） | ベースライン |
| D | **20** px（緩和） | 除外↓、精度↓ |

## 5. 予想される結果

### 10px（厳格化）
- 全体平均が11.3pxなので、**多くのフレームで追加除外が発生**
- 特にRKnee(12.2px), RAnkle(12.0px), Neck(11.9px)は頻繁に除外判定
- min_cameras=2の制約でNaN率が大幅に増加する恐れ
- 採用可能性: **低い**（過度に厳格すぎる）

### 12px（やや厳格化）
- 平均11.3pxに対して0.7pxの余裕 → **ある程度のフレームで追加除外**
- 再投影誤差が12-15pxの「境界的」な観測を除外 → 品質改善の余地あり
- NaN率の上昇は限定的と予想
- 採用可能性: **中程度**（バランスが取れる可能性）

### 20px（緩和）
- 現在除外されているカメラの一部が復活 → 実効カメラ数↑
- ただし誤差の大きい観測が混入 → Smoothness/Bone CV悪化の可能性
- 002案Bの結果（alpha=0でカメラ活用度↑→Smooth/L-R悪化）と同様のトレードオフ
- 採用可能性: **低い**（品質悪化のリスク大）

### 推奨テスト順

**12px → 10px → 20px**の順で実施。12pxが最も有望。

## 6. テスト手順

各条件について:
1. `Config.toml`の`reproj_error_threshold_triangulation`を変更
2. 三角測量 + フィルタリング実行
3. ログから各カメラの除外率を確認
4. `trc_evaluate`で評価
5. 結果を`pose-3d/reproj_{値}/`に保存

## 7. 成功基準

| 指標 | 目標 | 比較対象（ベースライン） |
|------|------|----------------------|
| Bone CV | ≤ 16.4% | 16.4% |
| Smoothness | ≤ 0.0139 | 0.0139 |
| L-R Diff | ≤ 4.9% | 4.9% |
| NaN率（フィルタ前TRC） | ≤ 5% | 0% |

## 8. 参考: 002案Bからの教訓

002案B（alpha=0）では、カメラ除外率を38%→21%に大幅低減したが、Smoothness/L-R Diffが悪化した。**カメラ活用度を上げると品質が悪化するトレードオフ**がある。reproj_error閾値の緩和（20px）も同様の結果になる可能性が高い。

逆に、閾値の厳格化（12px）は**ノイズの多い観測を積極的に除外**する方向であり、002案Aの「undistort=trueで除外が増えても残ったカメラの品質が向上」と同じ論理。こちらの方が有望。
