# 005: min_cameras_for_triangulation の最適化 [未着手]

## 1. 目的

`min_cameras_for_triangulation`（現在値: **2**）を最適化し、三角測量に必要な最低カメラ台数を見直す。

## 2. パラメータの動作

### コード上の動作（triangulation.py）

**whileループの終了条件（L408）**:
```python
while error_min > error_threshold_triangulation and n_cams - nb_cams_off >= min_cameras_for_triangulation:
```
- カメラを除外していく過程で、残りカメラ数がこの値を下回るとループ停止
- ループ停止時に再投影誤差がまだ閾値超過なら、そのキーポイントはNaN化（L600-L603）

**強制終了条件（L440）**:
```python
if nb_cams_off_tot > n_cams - min_cameras_for_triangulation:
    break
```

### 幾何学的意味

- **2台**: 三角測量の理論的最低数。解はあるが冗長性がなく、異常値検出不可
- **3台**: 冗長性あり。1台の外れ値を検出・除外可能。再投影誤差による品質評価が有効に機能
- **4台**: 全台使用。最高の冗長性だが、1台でも悪い観測があると全体が劣化

### 他パラメータとの相互作用

- min_cameras=3にすると、reproj_error_thresholdで「最悪のカメラを1台除外して3台で実行」というパスが使えなくなる（4→3は許可だが3→2は不許可）
- likelihood閾値で既に1-2台除外されている場合、min_cameras=3だとNaN化するフレームが急増

## 3. 現在のベースライン

### 有効カメラ数の分布（キーポイント別）

| 有効カメラ数 | キーポイント例 | 三角測量の品質 |
|-------------|-------------|--------------|
| 3.0-3.3台 | Hip, RAnkle, RKnee | 良好（冗長性あり） |
| 2.7-3.0台 | LShoulder, RWrist, RShoulder | 概ね良好 |
| 2.5-2.8台 | Neck, Head, Nose, LEar | やや不安定 |
| **2.5-2.6台** | **LElbow, LWrist** | **不安定（2台のフレームが多い）** |

### 2台になるフレームの推定割合

4台カメラ、平均除外率0.98台の場合:
- 2台（ちょうど2台使用）のフレーム比率: 推定15-30%（キーポイントによる）
- LWrist（除外1.49台）: 2台以下のフレームが**50%前後**と推定

## 4. テスト条件

| 条件 | min_cameras | 予想効果 |
|------|-----------|---------|
| A | **2**（現状） | ベースライン |
| B | **3**（厳格化） | 精度↑、NaN率↑↑ |

### 3台 vs 2台の詳細比較

| 項目 | min_cameras=2 | min_cameras=3 |
|------|:---:|:---:|
| 三角測量の精度 | 低い（冗長性なし） | 高い（異常値検出可） |
| カバレッジ | 高い（ほぼ全フレーム） | 低い（NaN増加） |
| 外れ値検出 | 不可（2台では判定できない） | 可能（3台の整合性で判定） |
| NaN率 | 0%（fill=last_value） | 推定10-30%（fill前） |

## 5. 予想される結果

### min_cameras=3 にした場合

**改善が期待される点**:
- 2台しか使えないフレームがNaN化 → fill_large_gaps_with=last_valueで補間
- 3台以上のフレームのみが「実測値」として残る → Bone CV/Smoothness改善の可能性
- 再投影誤差の計算が3台以上で行われるため、外れ値検出の精度が向上

**悪化が予想される点**:
- **NaN率の大幅増加**: 特にLWrist/LElbow（現在2.5-2.6台）は50%前後のフレームがNaN化
- **last_value補間の品質**: 長いNaNギャップをlast_valueで補間すると不自然な動きに
- **Bone CVの評価**: 補間フレームを含むとCVが人工的に低くなる可能性（動きがフリーズするため）

**重要な注意**: min_cameras=3の効果は`fill_large_gaps_with`の設定に強く依存。
- `last_value`: NaN区間はフリーズ（動きなし）→ Smoothnessは良く見えるが非現実的
- `nan`: NaN区間は欠損のまま → 評価指標から除外される → 「見かけ上」の精度改善
- `linear`/`spline`: 補間の質に依存

## 6. テスト手順

1. `Config.toml`の`min_cameras_for_triangulation = 3`に変更
2. 三角測量実行（フィルタリングなし）
3. **フィルタリング前TRCのNaN率を確認**（これが重要）
4. フィルタリング実行
5. `trc_evaluate`で評価
6. 結果を`pose-3d/min_cam3/`に保存

## 7. 成功基準

| 指標 | 目標 | 比較対象（ベースライン） |
|------|------|----------------------|
| Bone CV | ≤ 16.4% | 16.4% |
| Smoothness | ≤ 0.0139 | 0.0139 |
| L-R Diff | ≤ 4.9% | 4.9% |
| NaN率（フィルタ前TRC） | ≤ 15% | 0% |

NaN率が15%を超える場合は、実用性の観点から不採用。

## 8. リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| LWrist/LElbowのNaN率が50%超 | 高 | 007（fill戦略）と合わせて評価 |
| last_value補間で指標が人工的に改善 | 中 | フィルタ前TRCのNaN率を必ず確認 |
| 全体のNaN率が高すぎて実用不可 | 中 | min_cameras=2に戻す |
